# 요구사항 문서

## 소개

본 기능은 게임 QA 자동화 시스템의 의미론적 테스트 기록 및 재현 기능을 개선하는 것이다. 현재 시스템은 클릭 좌표와 스크린샷만 저장하여 동일한 조건에서만 테스트가 재현되지만, 이 기능을 통해 UI 요소의 의미론적 정보(버튼 텍스트, 아이콘 타입, 위치 관계 등)를 클릭 시점에 분석하여 저장하고, 재현 시 해당 의미론적 정보를 바탕으로 UI 요소를 다시 찾아 클릭함으로써 UI 좌표가 변경되거나 레이아웃이 약간 달라져도 테스트가 정상적으로 재현될 수 있도록 한다.

## 용어 정의

- **의미론적 액션 (Semantic Action)**: 물리적 좌표 정보와 함께 클릭 대상 UI 요소의 의미론적 정보(텍스트, 타입, 시각적 특징 등)를 포함하는 액션 데이터
- **의미론적 정보 (Semantic Info)**: UI 요소의 의미론적 정보를 담은 데이터 구조 (의도, 대상 요소, 맥락 포함)
- **대상 요소 (Target Element)**: 클릭 대상 UI 요소의 상세 정보 (타입, 텍스트, 설명, 시각적 특징, 경계 상자 등)
- **Vision LLM**: AWS Bedrock의 Claude 모델을 사용한 이미지 기반 UI 분석 시스템
- **의미론적 매칭 (Semantic Matching)**: 저장된 의미론적 정보를 바탕으로 현재 화면에서 동일한 UI 요소를 찾는 과정
- **경계 상자 (Bounding Box)**: UI 요소의 화면상 위치와 크기를 나타내는 사각형 영역 (x, y, 너비, 높이)
- **화면 전환 (Screen Transition)**: 액션 수행 전후의 화면 상태 변화
- **테스트 케이스 (Test Case)**: 기록된 액션들의 시퀀스와 메타데이터를 포함하는 테스트 정의
- **액션 기록기 (Action Recorder)**: 사용자 입력을 감지하고 기록하는 컴포넌트
- **액션 재생기 (Action Replayer)**: 기록된 액션을 재실행하는 컴포넌트

## 요구사항

### 요구사항 1: 클릭 시점 의미론적 정보 캡처

**사용자 스토리:** QA 엔지니어로서, 클릭 시점에 UI 요소의 의미론적 정보가 자동으로 분석되어 저장되기를 원한다. 이를 통해 나중에 UI 좌표가 변경되어도 테스트를 재현할 수 있다.

#### 인수 조건

1. WHEN 사용자가 클릭 액션을 수행하면 THEN 의미론적_액션_기록기는 클릭이 발생하기 직전에 스크린샷을 캡처해야 한다 (SHALL)
2. WHEN 클릭 전 스크린샷이 캡처되면 THEN 의미론적_액션_기록기는 5초 이내에 Vision LLM을 사용하여 클릭 좌표의 UI 요소를 분석해야 한다 (SHALL)
3. WHEN Vision LLM 분석이 완료되면 THEN 의미론적_액션_기록기는 대상 요소의 타입, 텍스트, 설명, 경계 상자를 추출하여 저장해야 한다 (SHALL)
4. WHEN 의미론적 액션이 기록되면 THEN 의미론적_액션_기록기는 물리적 좌표와 의미론적 정보를 모두 액션 데이터 구조에 저장해야 한다 (SHALL)
5. WHEN Vision LLM 분석이 실패하면 THEN 의미론적_액션_기록기는 OCR 기반 텍스트 추출로 폴백하여 가용한 정보를 저장해야 한다 (SHALL)

### 요구사항 2: 테스트 케이스에 의미론적 정보 저장

**사용자 스토리:** QA 엔지니어로서, 저장된 테스트 케이스에 의미론적 정보가 포함되기를 원한다. 이를 통해 테스트 케이스 파일만으로 UI 요소를 식별할 수 있다.

#### 인수 조건

1. WHEN 테스트 케이스가 저장되면 THEN 테스트_케이스_관리자는 각 클릭 액션에 의도, 대상 요소, 맥락을 포함하는 semantic_info 필드를 포함해야 한다 (SHALL)
2. WHEN 테스트 케이스가 저장되면 THEN 테스트_케이스_관리자는 클릭 전 스크린샷을 가리키는 screenshot_before_path 필드를 포함해야 한다 (SHALL)
3. WHEN 테스트 케이스가 저장되면 THEN 테스트_케이스_관리자는 semantic_info에 대상 요소의 경계 상자 좌표를 포함해야 한다 (SHALL)
4. WHEN 테스트 케이스가 로드되면 THEN 테스트_케이스_관리자는 JSON 구조에서 모든 의미론적 정보를 파싱하여 복원해야 한다 (SHALL)
5. WHEN 의미론적 정보가 직렬화되면 THEN 테스트_케이스_관리자는 모든 중첩 데이터를 보존하는 JSON 호환 형식을 사용해야 한다 (SHALL)

### 요구사항 3: 의미론적 매칭 기반 테스트 재현

**사용자 스토리:** QA 엔지니어로서, 테스트 재현 시 의미론적 매칭을 통해 UI 요소를 찾기를 원한다. 이를 통해 UI 좌표가 변경되어도 올바른 요소를 클릭할 수 있다.

#### 인수 조건

1. WHEN 클릭 액션을 재생할 때 THEN 의미론적_액션_재생기는 먼저 현재 화면을 캡처하고 Vision LLM을 사용하여 UI 요소를 분석해야 한다 (SHALL)
2. WHEN 현재 화면이 분석되면 THEN 의미론적_액션_재생기는 텍스트 유사도와 타입 매칭을 사용하여 감지된 각 UI 요소를 저장된 대상 요소와 비교해야 한다 (SHALL)
3. WHEN 신뢰도 0.7 이상으로 일치하는 UI 요소가 발견되면 THEN 의미론적_액션_재생기는 매칭된 요소의 현재 좌표를 클릭에 사용해야 한다 (SHALL)
4. WHEN 충분한 신뢰도로 일치하는 요소가 발견되지 않으면 THEN 의미론적_액션_재생기는 원래 기록된 좌표로 폴백해야 한다 (SHALL)
5. WHEN 의미론적 매칭이 사용되면 THEN 의미론적_액션_재생기는 원래 위치와 매칭된 위치 간의 좌표 차이를 로그로 기록해야 한다 (SHALL)

### 요구사항 4: 의미론적 매칭 정확도 리포팅

**사용자 스토리:** QA 엔지니어로서, 의미론적 매칭의 정확도를 확인할 수 있기를 원한다. 이를 통해 테스트 재현의 신뢰성을 평가할 수 있다.

#### 인수 조건

1. WHEN 재생 세션이 완료되면 THEN 재생_검증기는 의미론적으로 매칭된 액션 수와 좌표 기반으로 매칭된 액션 수를 보고해야 한다 (SHALL)
2. WHEN 의미론적 매칭이 수행되면 THEN 재생_검증기는 각 액션의 매칭 신뢰도 점수를 기록해야 한다 (SHALL)
3. WHEN 의미론적 매칭 중 좌표 변경이 발생하면 THEN 재생_검증기는 평균 및 최대 좌표 변위를 보고해야 한다 (SHALL)
4. WHEN 재생 보고서가 생성되면 THEN 재생_검증기는 모든 액션에 대한 매칭 방법(의미론적, 좌표, 실패) 분류를 포함해야 한다 (SHALL)

### 요구사항 5: 기존 테스트 케이스 보강

**사용자 스토리:** QA 엔지니어로서, 기존 테스트 케이스에 의미론적 정보를 추가할 수 있기를 원한다. 이를 통해 이전에 기록한 테스트도 의미론적 재현이 가능해진다.

#### 인수 조건

1. WHEN 의미론적 정보가 없는 레거시 테스트 케이스가 로드되면 THEN 테스트_케이스_보강기는 누락된 semantic_info 필드를 감지해야 한다 (SHALL)
2. WHEN 레거시 테스트 케이스에 대한 보강이 요청되면 THEN 테스트_케이스_보강기는 각 액션의 스크린샷을 로드하고 Vision LLM을 사용하여 분석해야 한다 (SHALL)
3. WHEN 보강을 위한 Vision LLM 분석이 완료되면 THEN 테스트_케이스_보강기는 추출된 UI 요소 정보로 semantic_info 필드를 채워야 한다 (SHALL)
4. WHEN 보강이 완료되면 THEN 테스트_케이스_보강기는 새로운 버전 식별자와 함께 업데이트된 테스트 케이스를 저장해야 한다 (SHALL)
5. WHEN 보강 중 스크린샷 파일이 누락되면 THEN 테스트_케이스_보강기는 해당 액션을 보강 불가로 표시하고 나머지 액션을 계속 처리해야 한다 (SHALL)
6. WHEN 테스트 케이스가 보강되면 THEN 테스트_케이스_보강기는 기존의 액션 후 스크린샷 경로(screenshot_path)와 검증 관련 데이터를 그대로 유지해야 한다 (SHALL)
7. WHEN 보강된 테스트 케이스가 재생되면 THEN 의미론적_액션_재생기는 기존의 액션 후 스크린샷 캡처 및 화면 전환 검증 기능을 동일하게 수행해야 한다 (SHALL)

### 요구사항 6: 직렬화/역직렬화 정확성

**사용자 스토리:** QA 엔지니어로서, 의미론적 정보의 직렬화와 역직렬화가 정확하게 동작하기를 원한다. 이를 통해 테스트 케이스를 저장하고 불러올 때 정보 손실이 없다.

#### 인수 조건

1. WHEN SemanticAction이 JSON으로 직렬화되면 THEN 직렬화기는 모든 semantic_info 필드를 포함하는 유효한 JSON 문자열을 생성해야 한다 (SHALL)
2. WHEN JSON 문자열이 SemanticAction으로 역직렬화되면 THEN 역직렬화기는 모든 semantic_info 필드를 동일한 값으로 복원해야 한다 (SHALL)
3. WHEN 직렬화 왕복(round-trip)이 수행되면 THEN 결과 SemanticAction은 원본 SemanticAction과 동등해야 한다 (SHALL)
4. WHEN semantic_info에 중첩 객체가 존재하면 THEN 직렬화기는 완전한 중첩 구조를 보존해야 한다 (SHALL)
5. WHEN 선택적 필드가 None이면 THEN 직렬화기는 일관되게 해당 필드를 생략하거나 null로 직렬화해야 한다 (SHALL)

